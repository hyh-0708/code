<!-- Use ChatGPT to query about dynamically drawing dynamic waveforms and dynamic circles. -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FinalPersona</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.8.0/lib/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.8.0/lib/addons/p5.sound.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <style>
      body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        background-color: #111827;
        color: #f3f4f6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4px;
      }

      .main-container {
        max-width: 896px;
        width: 100%;
        background-color: #1f2937;
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        padding: 24px;
        margin-bottom: 24px;
      }

      /* 按钮容器 */
      .button-container {
        display: flex;
        justify-content: center;
        margin-bottom: 24px;
      }

      /* 麦克风按钮 */
      .mic-button {
        color: white;
        font-weight: bold;
        padding: 12px 32px;
        border-radius: 8px;
        transition: all 0.3s ease;
        transform: translateY(0);
        outline: none;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
      }
      
      .mic-button i {
        margin-right: 8px;
      }
      
      .mic-button.primary {
        background-color: #3b82f6;
      }
      
      .mic-button.primary:hover {
        background-color: #2563eb;
        transform: translateY(-2px) scale(1.02);
      }
      
      .mic-button.primary:focus {
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5);
      }
      
      .mic-button.danger {
        background-color: #dc2626;
      }
      
      .mic-button.danger:hover {
        background-color: #b91c1c;
        transform: translateY(-2px) scale(1.02);
      }
      
      .mic-button.danger:focus {
        box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.5);
      }

      /* 内容容器 */
      .content-container {
        background-color: #374151;
        border-radius: 8px;
        padding: 16px;
        box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
      }
      
      .status-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .status-label {
        font-size: 14px;
        color: #9ca3af;
      }
      
      .status-value {
        font-size: 18px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

 

          /* 画布容器 */
      #canvasContainer {
        position: relative;
        overflow: hidden;
        width: 100%;
        background-color: #0f172a;
        border-radius: 8px;
      }

      /* p5.js画布样式 - 新增 */
      #canvasContainer canvas {
        display: block;
        width: 100% !important;
        height: 100% !important;
      }

      /* 权限覆盖层 */
      #permissionOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: rgba(17, 24, 39, 0.9);
        z-index: 10;
        transition: opacity 0.3s ease;
      }
      
      #permissionOverlay.hidden {
        opacity: 0;
        pointer-events: none;
      }
      
      .permission-icon {
        font-size: 60px;
        margin-bottom: 16px;
        color: #6b7280;
      }
      
      .permission-message {
        font-size: 20px;
        color: #9ca3af;
        text-align: center;
      }
    </style>
  </body>
  <body>
    <div class="main-container">
      <div class="button-container">
        <button id="micButton" class="mic-button primary">
           Enable Microphone
        </button>
      </div>
      <div class="content-container">
        <div class="status-row">
          <p class="status-label">Current Amplitude:</p>
          <span id="amplitudeDisplay" class="status-value">0.000</span>
        </div>
        <div id="canvasContainer">
          <div id="permissionOverlay">
            <p class="permission-message">Click the button to enable microphone</p>
          </div>
        </div>
      </div>
    </div>
    <script>
      // 音频相关变量
      let mic;
      let amplitude;
      let isMicEnabled = false;
      let overlay = document.getElementById('permissionOverlay');
      let AMPLIFICATION_FACTOR = 10;
      let audioContext; // 存储音频上下文

        
      document.getElementById('micButton').addEventListener('click', function(){
        toggleMic()
      });

      // 创建p5.js实例
      let sketch = new p5((p) => {
        p.setup = function() {
          let canvas = p.createCanvas(800, 450);
          canvas.parent("canvasContainer");
          p.background(0);
          
          // 初始化音频对象
          mic = new p5.AudioIn();
          amplitude = new p5.Amplitude();
          
          // 保存音频上下文以供外部使用
          audioContext = p.getAudioContext();
        };

        p.draw = function() {
          p.background(0);

          if (isMicEnabled) {
            if (!mic || !amplitude) {
              isMicEnabled = false;
              updateButtonUI(false);
              return;
            }

            try {
              let level = amplitude.getLevel();
              level = Math.min(level * AMPLIFICATION_FACTOR, 1.0);
              document.getElementById("amplitudeDisplay").textContent = level.toFixed(3);

              let displayWidth = p.width * 0.8;
              let displayHeight = p.height * 0.8;
              let radius = p.map(level, 0, 0.5, 20, displayHeight / 2);

              p.fill(30, 30, 30);
              p.ellipse(p.width / 2, p.height / 2, displayHeight, displayHeight);

              p.fill(65, 105, 225);
              p.ellipse(p.width / 2, p.height / 2, radius * 2, radius * 2);

              p.stroke(255);
              p.strokeWeight(2);
              p.noFill();
              p.beginShape();
              for (let i = 0; i < p.width; i++) {
                let x = i;
                let waveHeight = radius * 0.6;
                let y = p.map(p.sin(i * 0.1 + p.frameCount * 0.05) * level, -1, 1, p.height / 2 - waveHeight, p.height / 2 + waveHeight);
                p.vertex(x, y);
              }
              p.endShape();
            } catch (error) {
              console.error("Error in draw function:", error);
              isMicEnabled = false;
              updateButtonUI(false);
            }
          } else {
            p.fill(255);
            p.textSize(20);
            p.textAlign(p.CENTER, p.CENTER);
          }
        };

        p.windowResized = function() {
          let container = document.getElementById("canvasContainer");
          if (container) {
            let newWidth = container.offsetWidth;
            let newHeight = newWidth * 0.5625;
            p.resizeCanvas(newWidth, newHeight);
          }
        };
      });

      // 更新按钮UI
      function updateButtonUI(isEnabled) {
        let micButton = document.getElementById('micButton');
        if (isEnabled) {
          micButton.innerHTML = 'Disable Microphone';
          micButton.classList.remove("primary");
          micButton.classList.add("danger");
        } else {
          micButton.innerHTML = '<i class="fa fa-microphone mr-2"></i>Enable Microphone';
          micButton.classList.remove("danger");
          micButton.classList.add("primary");
        }
      }

      // 切换麦克风状态
      function toggleMic() {
        if (!isMicEnabled) {
          // 使用保存的音频上下文
          if (audioContext) {
            audioContext.resume()
              .then(() => {
                if (mic) {
                  mic.start();
                  setTimeout(() => {
                    try {
                      if (amplitude) {
                        amplitude.setInput(mic);
                        amplitude.smooth(0.8);
                        overlay.style.display = "none";
                        updateButtonUI(true);
                        isMicEnabled = true;
                      }
                    } catch (error) {
                      console.error("Failed to set audio input:", error);
                      alert("Microphone activation failed. Please check permissions or try again.");
                      updateButtonUI(false);
                    }
                  }, 500);
                }
              })
              .catch((error) => {
                console.error("Failed to resume audio context:", error);
                alert("Failed to enable audio: " + error.message);
              });
          } else {
            console.error("Audio context not initialized");
            alert("Audio system not ready. Please refresh the page.");
          }
        } else {
          if (mic) {
            mic.stop();
          }
          if (overlay) {
            overlay.style.display = "flex";
            overlay.innerHTML = `<p class="permission-message">Click the button to enable microphone</p>`;
          }

          updateButtonUI(false);
          isMicEnabled = false;
        }
      }
    </script>
  </body>
</html>